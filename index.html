<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PixifyWeather ‚òÄÔ∏è</title>
  <meta name="theme-color" content="#111827" id="theme-color" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for a cute hourly sparkline -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Extra flourish beyond Tailwind */
    .glass {
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.18);
    }

    .floaty {
      animation: floaty 6s ease-in-out infinite;
    }
    @keyframes floaty {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .spin-slow { animation: spin 12s linear infinite; }

    .skeleton { position: relative; overflow: hidden; background-color: rgba(255,255,255,0.08); }
    .skeleton::after {
      content: "";
      position: absolute; inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
      animation: shimmer 1.8s infinite;
    }
    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }
  </style>
</head>
<body class="min-h-screen text-white transition-colors duration-700">
  <!-- Dynamic background -->
  <div id="bg" class="fixed inset-0 -z-10 bg-gradient-to-br from-indigo-900 via-sky-900 to-emerald-900"></div>

  <!-- Decorative orbs -->
  <div class="pointer-events-none fixed -top-24 -left-24 h-72 w-72 rounded-full bg-white/10 blur-3xl"></div>
  <div class="pointer-events-none fixed -bottom-24 -right-24 h-72 w-72 rounded-full bg-cyan-400/10 blur-3xl"></div>

  <!-- App container -->
  <main class="mx-auto max-w-6xl p-4 md:p-8">
    <header class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-3xl sm:text-4xl font-black tracking-tight drop-shadow">PixifyWeather</h1>
      <div class="flex flex-wrap items-center gap-2">
        <button id="geoBtn" class="glass rounded-2xl px-4 py-2 text-sm md:text-base hover:scale-[1.02] active:scale-95 transition flex items-center gap-2">
          <i data-lucide="crosshair"></i> Use my location
        </button>
        <div class="glass rounded-2xl px-2 py-2 flex items-center gap-2">
          <button id="unitC" class="rounded-xl px-3 py-1 text-sm font-semibold bg-white/20">¬∞C</button>
          <button id="unitF" class="rounded-xl px-3 py-1 text-sm">¬∞F</button>
        </div>
        <button id="themeBtn" class="glass rounded-2xl px-3 py-2 text-sm flex items-center gap-2">
          <i data-lucide="moon"></i>
          Theme
        </button>
      </div>
    </header>

    <!-- Search + suggestions -->
    <section class="mb-6">
      <div class="glass rounded-3xl p-3 flex items-center gap-2">
        <i data-lucide="search" class="opacity-80"></i>
        <input id="search" type="text" placeholder="Search city‚Ä¶ (e.g., Tokyo)" class="w-full bg-transparent outline-none placeholder-white/60" />
        <button id="clearSearch" class="rounded-xl px-3 py-1 text-sm bg-white/10 hover:bg-white/20">Clear</button>
      </div>
      <div id="suggestions" class="mt-2 hidden"></div>
    </section>

    <!-- Favorites -->
    <section id="favoritesWrap" class="mb-6 hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold/7 opacity-90">Favorites</h2>
        <button id="clearFavs" class="text-xs underline opacity-70 hover:opacity-100">Clear</button>
      </div>
      <div id="favorites" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Weather panels -->
    <section class="grid gap-6 md:grid-cols-3">
      <!-- Current weather card -->
      <article class="md:col-span-2 glass rounded-3xl p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div class="flex items-center gap-4">
            <div id="bigIcon" class="text-6xl md:text-7xl floaty">üå§Ô∏è</div>
            <div>
              <div class="flex items-center gap-2">
                <h2 id="city" class="text-2xl md:text-3xl font-bold">‚Äî</h2>
                <button id="favBtn" class="glass rounded-xl px-2 py-1 text-xs flex items-center gap-1">
                  <i data-lucide="star"></i> Save
                </button>
              </div>
              <p id="subtitle" class="opacity-80 text-sm">Updated ‚Äî</p>
            </div>
          </div>
          <div class="text-right">
            <div id="temp" class="text-5xl md:text-6xl font-black tracking-tight">‚Äî¬∞</div>
            <div id="summary" class="opacity-90">‚Äî</div>
            <div id="hiLo" class="opacity-70 text-sm">H ‚Äî / L ‚Äî</div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="glass rounded-2xl p-4"><div class="opacity-70 text-sm">Feels like</div><div id="feels" class="text-xl font-semibold">‚Äî</div></div>
          <div class="glass rounded-2xl p-4"><div class="opacity-70 text-sm">Wind</div><div id="wind" class="text-xl font-semibold">‚Äî</div></div>
          <div class="glass rounded-2xl p-4"><div class="opacity-70 text-sm">Humidity</div><div id="humidity" class="text-xl font-semibold">‚Äî</div></div>
          <div class="glass rounded-2xl p-4"><div class="opacity-70 text-sm">Chance of precip</div><div id="precip" class="text-xl font-semibold">‚Äî</div></div>
        </div>
      </article>

      <!-- Hourly chart -->
      <article class="glass rounded-3xl p-6">
        <h3 class="font-semibold mb-3">Next 24h</h3>
        <div class="h-44">
          <canvas id="hourlyChart" class="!h-44"></canvas>
        </div>
      </article>

      <!-- 7-day forecast -->
      <article class="md:col-span-3 glass rounded-3xl p-6">
        <h3 class="font-semibold mb-4">7-day Forecast</h3>
        <div id="forecast" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-3"></div>
      </article>
    </section>

    <!-- Toast -->
    <div id="toast" class="fixed left-1/2 top-4 -translate-x-1/2 hidden">
      <div class="glass rounded-2xl px-4 py-2 text-sm flex items-center gap-2">
        <i data-lucide="info"></i>
        <span id="toastMsg">Message</span>
      </div>
    </div>
        <!-- Toast -->
    <div id="toast" class="fixed left-1/2 top-4 -translate-x-1/2 hidden">
      <div class="glass rounded-2xl px-4 py-2 text-sm flex items-center gap-2">
        <i data-lucide="info"></i>
        <span id="toastMsg">Message</span>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 text-center opacity-80 text-sm">
      <p class="flex items-center justify-center gap-2">
        Made with 
        <span class="animate-pulse">‚ù§Ô∏è</span> 
        by <span class="font-semibold">Anish</span>
      </p>
    </footer>

  </main>

  </main>

  <script>
    // --- State ---
    const state = {
      unit: localStorage.getItem('unit') || 'celsius', // 'celsius' or 'fahrenheit'
      lastLoc: JSON.parse(localStorage.getItem('lastLoc') || 'null'),
      favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
      chart: null,
    };

    // --- Helpers ---
    const $ = (s) => document.querySelector(s);
    const el = (tag, cls = '') => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };

    const toast = (msg) => {
      $('#toastMsg').textContent = msg;
      $('#toast').classList.remove('hidden');
      setTimeout(() => $('#toast').classList.add('hidden'), 2200);
    };

    const fmtTemp = (v) => `${Math.round(v)}¬∞`;

    const unitParams = () => ({
      temperature_unit: state.unit === 'celsius' ? 'celsius' : 'fahrenheit',
      wind_speed_unit: state.unit === 'celsius' ? 'kmh' : 'mph'
    });

    const wmoMap = (code, isDay) => {
      // Basic icon and label mapping for Open-Meteo weather codes
      const map = [
        {r:[0], l:'Clear sky', d:'‚òÄÔ∏è', n:'üåô'},
        {r:[1,2], l:'Partly cloudy', d:'üå§Ô∏è', n:'‚òÅÔ∏è'},
        {r:[3], l:'Overcast', d:'‚òÅÔ∏è', n:'‚òÅÔ∏è'},
        {r:[45,48], l:'Fog', d:'üå´Ô∏è', n:'üå´Ô∏è'},
        {r:[51,53,55,56,57], l:'Drizzle', d:'üå¶Ô∏è', n:'üå¶Ô∏è'},
        {r:[61,63,65,66,67], l:'Rain', d:'üåßÔ∏è', n:'üåßÔ∏è'},
        {r:[71,73,75,77], l:'Snow', d:'‚ùÑÔ∏è', n:'‚ùÑÔ∏è'},
        {r:[80,81,82], l:'Showers', d:'üå¶Ô∏è', n:'üåßÔ∏è'},
        {r:[85,86], l:'Snow showers', d:'üå®Ô∏è', n:'üå®Ô∏è'},
        {r:[95], l:'Thunderstorm', d:'‚õàÔ∏è', n:'‚õàÔ∏è'},
        {r:[96,99], l:'Severe thunderstorm', d:'‚õàÔ∏è', n:'‚õàÔ∏è'},
      ];
      for (const m of map) if (m.r.includes(code)) return { label: m.l, icon: isDay? m.d : m.n };
      return { label: '‚Äî', icon: '‚ùì' };
    };

    const setBackgroundFor = (code, isDay) => {
      const bg = $('#bg');
      const theme = $('#theme-color');
      let from, via, to;
      if ([0,1,2].includes(code) && isDay) { from = 'from-sky-400'; via = 'via-indigo-500'; to = 'to-amber-300'; theme.content = '#38bdf8'; }
      else if ([3,45,48].includes(code)) { from = 'from-slate-700'; via = 'via-slate-800'; to = 'to-slate-900'; theme.content = '#0f172a'; }
      else if ([61,63,65,80,81,82].includes(code)) { from = 'from-indigo-800'; via = 'via-sky-900'; to = 'to-cyan-900'; theme.content = '#0ea5e9'; }
      else if ([71,73,75,77,85,86].includes(code)) { from = 'from-blue-800'; via = 'via-indigo-900'; to = 'to-zinc-900'; theme.content = '#1e40af'; }
      else if ([95,96,99].includes(code)) { from = 'from-purple-900'; via = 'via-indigo-900'; to = 'to-slate-900'; theme.content = '#581c87'; }
      else if (isDay) { from = 'from-sky-500'; via = 'via-indigo-700'; to = 'to-emerald-700'; theme.content = '#2563eb'; }
      else { from = 'from-slate-800'; via = 'via-indigo-900'; to = 'to-black'; theme.content = '#0b1220'; }
      bg.className = `fixed inset-0 -z-10 bg-gradient-to-br ${from} ${via} ${to} transition-colors duration-700`;
    };

    const saveLastLoc = (obj) => localStorage.setItem('lastLoc', JSON.stringify(obj));
    const saveFavorites = () => localStorage.setItem('favorites', JSON.stringify(state.favorites));

    // --- UI Binding ---
    const bindFavorites = () => {
      const wrap = $('#favorites');
      const section = $('#favoritesWrap');
      wrap.innerHTML = '';
      if (!state.favorites.length) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');
      state.favorites.slice(0, 8).forEach((f, idx) => {
        const b = el('button', 'glass rounded-2xl px-3 py-2 text-sm hover:scale-[1.02] active:scale-95 transition');
        b.textContent = `${f.name}`;
        b.onclick = () => {
          saveLastLoc(f);
          fetchAndRender(f.lat, f.lon, f.name);
        };
        wrap.appendChild(b);
      });
    };

    const toggleFav = (loc) => {
      const exists = state.favorites.some(f => f.lat === loc.lat && f.lon === loc.lon && f.name === loc.name);
      if (exists) {
        state.favorites = state.favorites.filter(f => !(f.lat === loc.lat && f.lon === loc.lon && f.name === loc.name));
        toast('Removed from favorites');
      } else {
        state.favorites.unshift(loc);
        toast('Saved to favorites');
      }
      saveFavorites();
      bindFavorites();
    };

    // --- Fetching ---
    async function geocode(name) {
      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.search = new URLSearchParams({ name, count: 5, language: 'en', format: 'json' });
      const res = await fetch(url);
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      return (data.results || []).map(r => ({
        name: `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ', ' + r.country : ''}`,
        lat: r.latitude,
        lon: r.longitude
      }));
    }

    async function fetchWeather(lat, lon) {
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.search = new URLSearchParams({
        latitude: lat,
        longitude: lon,
        current: 'temperature_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,relative_humidity_2m',
        hourly: 'temperature_2m,precipitation_probability,relative_humidity_2m',
        daily: 'weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max',
        timezone: 'auto',
        forecast_days: 7,
        temperature_unit: unitParams().temperature_unit,
        wind_speed_unit: unitParams().wind_speed_unit
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error('Weather fetch failed');
      return res.json();
    }

    // --- Rendering ---
    function renderSuggestions(list) {
      const box = $('#suggestions');
      box.innerHTML = '';
      if (!list.length) { box.classList.add('hidden'); return; }
      box.classList.remove('hidden');
      const wrap = el('div', 'grid gap-2 sm:grid-cols-2');
      list.forEach(item => {
        const b = el('button', 'glass rounded-2xl p-3 text-left hover:scale-[1.01] transition');
        b.innerHTML = `<div class="font-medium">${item.name}</div><div class="opacity-70 text-sm">${item.lat.toFixed(2)}, ${item.lon.toFixed(2)}</div>`;
        b.onclick = () => {
          $('#search').value = item.name;
          $('#suggestions').classList.add('hidden');
          saveLastLoc(item);
          fetchAndRender(item.lat, item.lon, item.name);
        };
        wrap.appendChild(b);
      });
      box.appendChild(wrap);
    }

    function renderCurrent(name, data) {
      const cur = data.current;
      const d = wmoMap(cur.weather_code, !!cur.is_day);
      $('#bigIcon').textContent = d.icon;
      $('#city').textContent = name;
      $('#summary').textContent = d.label;
      $('#temp').textContent = fmtTemp(cur.temperature_2m);
      $('#feels').textContent = fmtTemp(cur.apparent_temperature);
      $('#wind').textContent = `${Math.round(cur.wind_speed_10m)} ${state.unit === 'celsius' ? 'km/h' : 'mph'}`;
      $('#humidity').textContent = `${Math.round(cur.relative_humidity_2m)}%`;
      const todayIdx = 0;
      const h = data.daily.temperature_2m_max[todayIdx];
      const l = data.daily.temperature_2m_min[todayIdx];
      $('#hiLo').textContent = `H ${fmtTemp(h)} / L ${fmtTemp(l)}`;
      const now = new Date();
      $('#subtitle').textContent = `Updated ${now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
      setBackgroundFor(cur.weather_code, !!cur.is_day);
    }

    function renderForecast(data) {
      const box = $('#forecast');
      box.innerHTML = '';
      const days = data.daily.time;
      days.forEach((t, i) => {
        const code = data.daily.weather_code[i];
        const { label, icon } = wmoMap(code, true);
        const card = el('div', 'rounded-2xl p-4 glass text-center hover:scale-[1.01] transition');
        const d = new Date(t);
        card.innerHTML = `
          <div class="text-sm opacity-80">${d.toLocaleDateString(undefined, { weekday: 'short' })}</div>
          <div class="text-3xl my-1">${icon}</div>
          <div class="text-xs opacity-70">${label}</div>
          <div class="mt-2 font-semibold">${fmtTemp(data.daily.temperature_2m_max[i])} / ${fmtTemp(data.daily.temperature_2m_min[i])}</div>
          <div class="text-xs opacity-70">Rain: ${data.daily.precipitation_probability_max[i] ?? 0}%</div>
        `;
        box.appendChild(card);
      });
    }

    function renderHourlyChart(data) {
      const labels = data.hourly.time.slice(0, 24).map(t => new Date(t).toLocaleTimeString([], { hour: '2-digit' }));
      const temps = data.hourly.temperature_2m.slice(0, 24);
      const ctx = document.getElementById('hourlyChart');
      if (state.chart) { state.chart.destroy(); }
      state.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `Temp next 24h (${state.unit === 'celsius' ? '¬∞C' : '¬∞F'})`,
            data: temps,
            fill: false,
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
            y: { grid: { display: false } }
          }
        }
      });
    }

    function setPrecipChance(data) {
      // Use next 24h max precip probability as a quick stat
      const probs = (data.hourly.precipitation_probability || []).slice(0, 24).filter(v => typeof v === 'number');
      const max = probs.length ? Math.max(...probs) : 0;
      $('#precip').textContent = `${max}%`;
    }

    function startSkeleton() {
      ['#temp','#summary','#hiLo','#feels','#wind','#humidity','#precip'].forEach(s => {
        const n = $(s); n.dataset._text = n.textContent; n.classList.add('skeleton'); n.textContent = ' ';
      });
    }
    function stopSkeleton() {
      ['#temp','#summary','#hiLo','#feels','#wind','#humidity','#precip'].forEach(s => {
        const n = $(s); n.classList.remove('skeleton'); if (n.dataset._text) delete n.dataset._text;
      });
    }

    async function fetchAndRender(lat, lon, name = '‚Äî') {
      try {
        startSkeleton();
        const data = await fetchWeather(lat, lon);
        renderCurrent(name, data);
        renderForecast(data);
        renderHourlyChart(data);
        setPrecipChance(data);
        stopSkeleton();
        // Update favorite button state/label
        const isFav = state.favorites.some(f => f.lat === lat && f.lon === lon && f.name === name);
        $('#favBtn').innerHTML = `${isFav ? '<i data-lucide="star"></i> Saved' : '<i data-lucide="star"></i> Save'}`;
        lucide.createIcons();
      } catch (e) {
        stopSkeleton();
        console.error(e);
        toast('Could not load weather. Try again.');
      }
    }

    // --- Events ---
    function bindEvents() {
      // Unit toggle
      const setUnit = (u) => {
        state.unit = u; localStorage.setItem('unit', u);
        $('#unitC').classList.toggle('bg-white/20', u==='celsius');
        $('#unitF').classList.toggle('bg-white/20', u==='fahrenheit');
        // refetch for last location
        const loc = JSON.parse(localStorage.getItem('lastLoc') || 'null');
        if (loc) fetchAndRender(loc.lat, loc.lon, loc.name);
      };
      $('#unitC').onclick = () => setUnit('celsius');
      $('#unitF').onclick = () => setUnit('fahrenheit');

      // Theme toggle (just flips a dark-ish palette by applying a class to body)
      $('#themeBtn').onclick = () => {
        document.body.classList.toggle('invert');
      };

      // Geolocate
      $('#geoBtn').onclick = () => {
        if (!navigator.geolocation) return toast('Geolocation not supported');
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude: lat, longitude: lon } = pos.coords;
          // Reverse geocode-ish: pull a place name via geocoding nearby
          try {
            const nearby = await geocode(`${lat},${lon}`); // Not true reverse, but will often return something nearby
            const name = nearby?.[0]?.name || 'My location';
            const loc = { lat, lon, name };
            saveLastLoc(loc);
            fetchAndRender(lat, lon, name);
          } catch {
            const name = 'My location';
            saveLastLoc({ lat, lon, name });
            fetchAndRender(lat, lon, name);
          }
        }, () => toast('Location permission denied'));
      };

      // Favorites
      $('#favBtn').onclick = () => {
        const loc = JSON.parse(localStorage.getItem('lastLoc') || 'null');
        if (!loc) return toast('Nothing to save yet');
        toggleFav(loc);
      };
      $('#clearFavs').onclick = () => { state.favorites = []; saveFavorites(); bindFavorites(); };

      // Search typing
      let t; const box = $('#suggestions');
      $('#search').addEventListener('input', (e) => {
        const q = e.target.value.trim();
        if (!q) { box.classList.add('hidden'); return; }
        clearTimeout(t);
        t = setTimeout(async () => {
          try { const list = await geocode(q); renderSuggestions(list); }
          catch { box.classList.add('hidden'); }
        }, 250);
      });

      $('#clearSearch').onclick = () => { $('#search').value = ''; $('#suggestions').classList.add('hidden'); };

      // Click away to hide suggestions
      document.addEventListener('click', (e) => {
        if (!$('#suggestions').contains(e.target) && e.target !== $('#search')) {
          $('#suggestions').classList.add('hidden');
        }
      });

      // Enter key to search top result
      $('#search').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim();
          if (!q) return;
          try { const list = await geocode(q); if (list[0]) { saveLastLoc(list[0]); fetchAndRender(list[0].lat, list[0].lon, list[0].name); $('#suggestions').classList.add('hidden'); } }
          catch { toast('Search failed'); }
        }
      });
    }

    // --- Init ---
    function start() {
      lucide.createIcons();
      bindEvents();
      bindFavorites();
      // Load last location or a pleasant default
      const loc = state.lastLoc || { name: 'New York, US', lat: 40.71, lon: -74.01 };
      saveLastLoc(loc);
      fetchAndRender(loc.lat, loc.lon, loc.name);
    }

    document.addEventListener('DOMContentLoaded', start);
  </script>
</body>
</html>
